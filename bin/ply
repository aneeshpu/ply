#!/usr/bin/env python
import os
import sys

import ply
from ply import git


def die(msg):
    print msg
    sys.exit(1)


def usage():
    die("usage: ply <cmd>")


def do_init(_, *args):
    """Link a working repo to a patch repo."""
    if not args:
        die("ply init <patch-repo-path>")

    patch_repo_path = args[0]

    patch_repo = ply.PatchRepo(patch_repo_path)
    patch_repo.initialize()


def do_resolve(working_repo):
    """Mark conflicts for a patch as resolved and continue applying the rest
    of the patches in the series.
    """
    working_repo.resolve()


def do_restore(working_repo):
    """Apply the patch series to the the current branch of the working-repo.
    """
    try:
        working_repo.restore()
    except ply.git.exc.PatchDidNotApplyCleanly:
        print "Patch did not apply cleanly. To fix:"
        print
        print "\t1) Fix conflicts in affected files"
        print "\n\t2) `git add` affected files"
        print "\n\t3) Run `ply resolve` to refresh the patch and"\
              " apply the rest\n\t   of the patches in the series."
        sys.exit(1)


def do_save(working_repo, *args):
    """Saves last commit as a new patch in the patch-repo."""
    quiet = ('--quiet' in args) or ('-q' in args)
    working_repo.save(quiet=quiet)


def main():
    if len(sys.argv) < 2:
        usage()

    cmd = sys.argv[1]
    func = globals().get('do_%s' % cmd)
    if func:
        working_repo = ply.WorkingRepo('.')
        func(working_repo, *sys.argv[2:])
    else:
        die("command '%s' not found" % cmd)


if __name__ == "__main__":
    main()
